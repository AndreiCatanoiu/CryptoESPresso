<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoESPresso</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="scanlines"></div>
    <div class="grid-bg"></div>

    <div class="container">
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <span class="logo-icon">&#9919;</span>
                </div>
                <div class="title-block">
                    <h1>Crypto<span class="accent">ESP</span>resso</h1>
                    <p class="subtitle">INTERACTIVE CRYPTOGRAPHY VISUALIZER</p>
                </div>
            </div>
            <div class="header-right">
                <label for="algorithm">ALGORITHM</label>
                <select id="algorithm">
                    <option value="aes128" selected>AES-128</option>
                    <option value="aes256">AES-256</option>
                    <option value="des">DES</option>
                    <option value="3des">3DES</option>
                    <option value="chacha20">ChaCha20</option>
                    <option value="sha256">SHA-256</option>
                    <option value="sha512">SHA-512</option>
                    <option value="md5">MD5</option>
                    <option value="hmac_sha256">HMAC-SHA256</option>
                    <option value="rsa">RSA</option>
                </select>
            </div>
        </header>

        <div class="divider"></div>

        <div class="work-row">
            <div class="input-block">
                <label for="plaintext">INPUT</label>
                <textarea id="plaintext" placeholder="Enter plaintext..." rows="6"></textarea>
                <div class="char-count">
                    <span id="char-count">0</span> bytes
                </div>
            </div>

            <div class="process-block">
                <div class="arrow-line top"></div>
                <button id="process-btn" onclick="processRequest()">
                    <span class="btn-text">CALCULATE</span>
                    <span class="btn-loader" hidden>
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </span>
                </button>
                <div class="arrow-line bottom"></div>
            </div>

            <div class="output-block">
                <label>OUTPUT</label>
                <div class="output-box" id="output-box">
                    <span class="output-placeholder">Awaiting input...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const MAX_BUF = 1024;
        const JSON_OVERHEAD = 64; 
        const MAX_TEXT_BYTES = MAX_BUF - JSON_OVERHEAD;

        function byteLength(str) {
            return new TextEncoder().encode(str).length;
        }

        const textarea = document.getElementById('plaintext');
        const counter = document.getElementById('char-count');

        textarea.addEventListener('input', function () {
            while (byteLength(this.value) > MAX_TEXT_BYTES) {
                this.value = this.value.slice(0, -1);
            }
            counter.textContent = byteLength(this.value);
        });

        async function processRequest() {
            const text = textarea.value.trim();
            if (!text) {
                textarea.classList.add('error');
                setTimeout(() => textarea.classList.remove('error'), 600);
                return;
            }

            const algo = document.getElementById('algorithm').value;
            const outputBox = document.getElementById('output-box');

            const payload = JSON.stringify({
                text: text,
                algorithm: algo
            });

            if (byteLength(payload) >= MAX_BUF) {
                outputBox.textContent = "Payload too large for ESP32 buffer (1024 bytes).";
                outputBox.classList.add('has-result');
                return;
            }

            const btn = document.getElementById('process-btn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoader = btn.querySelector('.btn-loader');

            btn.disabled = true;
            btnText.hidden = true;
            btnLoader.hidden = false;
            textarea.disabled = true;
            document.getElementById('algorithm').disabled = true;

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: payload
                });

                const data = await response.json();
                outputBox.textContent = data.result || 'No result returned.';
                outputBox.classList.add('has-result');
            } catch (err) {
                outputBox.textContent = 'ERROR: ' + err.message;
                outputBox.classList.add('has-result');
            } finally {
                btn.disabled = false;
                btnText.hidden = false;
                btnLoader.hidden = true;
                textarea.disabled = false;
                document.getElementById('algorithm').disabled = false;
            }
        }

        textarea.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') processRequest();
        });
    </script>
</body>
</html>